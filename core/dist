#!/bin/bash
# (C) 2013-2016 David 'Mokon' Bond, All Rights Reserved

# A function to determine the distribution and pkg management tool
menv_function determine_dist
function determine_dist {
  if type lsb_release &> /dev/null ; then
    DIST=$(lsb_release -a | grep "Distributor ID" | awk {'print tolower($3)'})
  else
    DIST=""
  fi

  if [ -z $DIST ] && [ -f /etc/redhat-release ] ; then
    if grep -q Fedora /etc/redhat-release; then
      DIST=fedora
    fi

    if grep -q CentOS /etc/redhat-release; then
      DIST=centos
    fi
  fi

  if [ -z $DIST ] && [ -f /etc/debian_version ] ; then
    DIST=debian
  fi

  if [ -z $DIST ] && [ -f /etc/os-release ] ; then
    DIST="unknown"
  fi

  case $DIST in
    *fedora*|*centos*)
      PKG_TYPE=rpm ;
      version=`sed -rn 's/VERSION_ID=(.*)/\1/p' /etc/os-release | sed 's/"//g'`

      if [ "$version" -ge "22" ] ; then
        PKG_MGMT=dnf
      else
        PKG_MGMT=yum
      fi
      ;;
    *redhat*) PKG_TYPE=rpm ; PKG_MGMT=yum ;;
    *debian*|*ubuntu*) PKG_TYPE=dpkg ; PKG_MGMT=apt ;;
    *) PKG_TYPE=unknown ; PKG_MGMT=unknown ; echo "Unknown Distribution" ;;
  esac

  menv_export DIST
  menv_export PKG_TYPE
  menv_export PKG_MGMT
}

determine_dist

menv_alias dist_install=${DIST}_install
menv_alias dist_local_install=${DIST}_local_install
menv_alias ins=dist_install
menv_alias ${DIST}_install=${PKG_MGMT}_install
menv_alias ${DIST}_local_install=${PKG_MGMT}_local_install

menv_alias dist_update=${DIST}_update
menv_alias ${DIST}_update=${PKG_MGMT}_update

menv_alias yum_install="sudo yum install -q -y"
menv_alias dnf_install="sudo dnf install -q -y"
menv_alias apt_install="sudo apt-get --yes --force-yes install -qq"

menv_alias yum_update="sudo yum update -q -y"
menv_alias dnf_update="sudo dnf update -q -y"

menv_alias yum_local_install="sudo yum localinstall -q -y --nogpgcheck"
menv_alias dnf_local_install="sudo dnf install -q -y"

menv_alias global_install_package="install_package"

menv_alias update_packages=dist_update

menv_function install_package
function install_package {
  dist_to_pkg=$1

  eval "local pkg=\${$dist_to_pkg[$DIST]}"

  echo "Installing package '$pkg'"

  dist_install $pkg  2>&1 | grep -v "already installed"
}

menv_function local_install_package
function local_install_package {
  pkg=$1

  dist_local_install $pkg  2>&1 | grep -v "already installed"
}

menv_function install_simple_package
function install_simple_package {
  local pkg_name=$1

  pkg_arr=(
    [debian]="$pkg_name"
    [fedora]="$pkg_name"
    [centos]="$pkg_name"
  )

  install_package pkg_arr
}

menv_function install_simple_packages
function install_simple_packages {
  for package in "$@" ; do
    #install_simple_package $package
  done
}
